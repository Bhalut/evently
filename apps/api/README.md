# Evently API

**NestJS backend with TypeORM, PostgreSQL, and comprehensive security features**

## Overview

The Evently API is a production-ready NestJS application that provides RESTful endpoints for event management, user authentication, and platform features. Built with TypeScript, it emphasizes type safety, security hardening, and operational excellence.

### Key Features

**Core Functionality**

- Event CRUD operations with validation
- JWT-based authentication with Passport
- RESTful API design following best practices
- OpenAPI/Swagger documentation
- Health monitoring endpoints

**Security**

- Helmet middleware for HTTP security headers
- CORS with configurable origins
- Rate limiting (100 requests/minute per IP)
- Content Security Policy headers
- Input validation with class-validator
- Password hashing with bcrypt

**Observability**

- Structured JSON logging with Pino
- Request correlation IDs
- Performance monitoring
- Database query logging

## Configuration

Environment variables are validated at startup using Zod schemas. The API will fail fast if required variables are missing or invalid.

### Required Environment Variables

| Variable       | Description                              | Example                                   |
| -------------- | ---------------------------------------- | ----------------------------------------- |
| `DATABASE_URL` | PostgreSQL connection string             | `postgresql://app:app@localhost:5432/app` |
| `JWT_SECRET`   | Secret key for JWT signing (min 8 chars) | Auto-generated by CLI                     |
| `PORT`         | API server port                          | `3001`                                    |
| `NODE_ENV`     | Environment mode                         | `development`                             |
| `CORS_ORIGIN`  | Allowed CORS origins                     | `*` or specific domain                    |

### Setup

1. Copy environment template:

```bash
cp .env.example .env
```

2. Edit `.env` file with your configuration

## Running the API

### Development Mode

```bash
cd apps/api
pnpm dev
```

The API will be available at `http://localhost:3001`

### Production Build

```bash
cd apps/api
pnpm build

# Start production server
pnpm start:prod
```

## API Documentation

### Swagger UI

Interactive API documentation is available at:

```
http://localhost:3001/docs
```

### OpenAPI Specification

The OpenAPI JSON specification is available at:

```
http://localhost:3001/docs-json
```

This can be imported into API clients like Postman or Insomnia.

## Database

### Architecture

- **ORM**: TypeORM with PostgreSQL driver
- **Migrations**: Manual, version-controlled migration files
- **Entities**: Auto-discovered from modules (`autoLoadEntities: true`)
- **Synchronization**: Disabled (`synchronize: false`) - always use migrations

### Connection Details

- **Development**: `localhost:5432` via docker-compose.yml
- **Connection String**: Set via `DATABASE_URL` environment variable

### Database Operations

#### Running Migrations

```bash
cd apps/api
pnpm migration:run
```

#### Generating Migrations

```bash
cd apps/api
pnpm migration:generate -n DescriptiveMigrationName
```

Migrations are created in `src/database/migrations/`.

## API Endpoints

| Method | Endpoint        | Description                |
| ------ | --------------- | -------------------------- |
| POST   | `/events`       | Create a new event         |
| GET    | `/events`       | Get all events             |
| GET    | `/events/:id`   | Get a specific event by ID |
| PUT    | `/events/:id`   | Update an existing event   |
| DELETE | `/events/:id`   | Delete an event            |
| POST   | `/auth/login`   | User login                 |
| POST   | `/api/register` | User registration          |

## API Usage Examples

### Health Check

```bash
curl http://localhost:3001/health
```

Response:

```json
{
  "status": "ok",
  "info": {
    "database": { "status": "up" }
  }
}
```

### Create Event

```bash
curl -X POST http://localhost:3001/events \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Tech Conference 2026",
    "date": "2026-06-15T09:00:00Z",
    "description": "Annual technology conference",
    "place": "San Francisco, CA"
  }'
```

### List Events

```bash
curl http://localhost:3001/events
```

### Get Single Event

```bash
curl http://localhost:3001/events/1
```

### Update Event

```bash
curl -X PUT http://localhost:3001/events/1 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Event Name",
    "date": "2026-06-16T09:00:00Z",
    "description": "Updated description",
    "place": "San Francisco, CA"
  }'
```

### Delete Event

```bash
curl -X DELETE http://localhost:3001/events/1
```

### User Login

```bash
curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'
```

### User Registration

```bash
curl -X POST http://localhost:3001/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "email": "john@example.com",
    "password": "password123"
  }'
```

## Security Features

### HTTP Security Headers

Helmet middleware configures:

- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Strict-Transport-Security
- Content-Security-Policy

### Rate Limiting

- 100 requests per minute per IP address
- Configurable via environment variables
- Returns 429 Too Many Requests when exceeded

### CORS

Cross-Origin Resource Sharing is configured to allow requests from:

- Development: All origins (`*`)
- Production: Specific domains via `CORS_ORIGIN` environment variable

### Input Validation

All DTOs use class-validator decorators:

- Type validation
- Format validation
- Required field enforcement
- Whitelist mode (strips unknown properties)

## Testing

### Unit Tests

```bash
cd apps/api

# Run all unit tests
pnpm test

# Run with coverage (50% threshold enforced)
pnpm test:cov
```

### Integration Tests

Integration tests use an ephemeral database on port 5434:

```bash
# Start test database
docker compose -f docker-compose.test.yml up -d

# Run integration tests
pnpm test:integration

# Cleanup
docker compose -f docker-compose.test.yml down
```

## Development Commands

```bash
# Start in watch mode
pnpm dev

# Build for production
pnpm build

# Format code
pnpm format

# Lint code
pnpm lint

# Type check
pnpm check-types
```

## Troubleshooting

### Database Connection Errors

```bash
# Verify database is running
docker compose ps db

# Check connection string
echo $DATABASE_URL

# Restart database
docker compose down
docker compose up -d db
```

### Migration Failures

```bash
# Revert last migration
pnpm migration:revert

# Check database schema
docker compose exec db psql -U postgres -d evently -c "\dt"
```

### Port Already in Use

```bash
# Find process using port 3001
lsof -ti:3001

# Kill process
lsof -ti:3001 | xargs kill -9
```
