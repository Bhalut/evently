# Evently API

**NestJS backend with TypeORM, PostgreSQL, and comprehensive security features**

## Overview

The Evently API is a production-ready NestJS application that provides RESTful endpoints for event management, user authentication, and platform features. Built with TypeScript, it emphasizes type safety, security hardening, and operational excellence.

### Key Features

**Core Functionality**
- Event CRUD operations with validation
- JWT-based authentication with Passport
- RESTful API design following best practices
- OpenAPI/Swagger documentation
- Health monitoring endpoints

**Security**
- Helmet middleware for HTTP security headers
- CORS with configurable origins
- Rate limiting (100 requests/minute per IP)
- Content Security Policy headers
- Input validation with class-validator
- Password hashing with bcrypt

**Observability**
- Structured JSON logging with Pino
- Request correlation IDs
- Performance monitoring
- Database query logging

## Configuration

Environment variables are validated at startup using Zod schemas (apps/api/src/config/env.ts). The API will fail fast if required variables are missing or invalid.

### Required Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `DATABASE_URL` | PostgreSQL connection string | `postgresql://app:app@localhost:5432/app` |
| `JWT_SECRET` | Secret key for JWT signing (min 8 chars) | Auto-generated by CLI |
| `PORT` | API server port | `3000` |
| `NODE_ENV` | Environment mode | `development` |
| `CORS_ORIGIN` | Allowed CORS origins | `*` or specific domain |

### Setup

Use the interactive setup wizard from the monorepo root:

```bash
# From repository root
./packages/cli/bin/evently setup
```

Or manually create `.env`:

```bash
cp .env.example .env
# Edit .env with your configuration
```

## Running the API

### Development Mode

```bash
# From monorepo root
pnpm --filter api dev

# Or from apps/api directory
pnpm dev
```

The API will be available at `http://localhost:3000` (or configured PORT).

### Production Build

```bash
# Build
pnpm build

# Start production server
pnpm start:prod
```

### Docker

```bash
# From repository root - start all services
docker compose up

# API will be available at http://localhost:3001
```

## API Documentation

### Swagger UI

Interactive API documentation is available at `/docs`:

```
http://localhost:3000/docs
```

### OpenAPI Specification

The OpenAPI JSON specification is available at `/docs-json`:

```
http://localhost:3000/docs-json
```

This can be imported into API clients like Postman or Insomnia.

## Database

### Architecture

- **ORM**: TypeORM with PostgreSQL driver
- **Migrations**: Manual, version-controlled migration files
- **Entities**: Auto-discovered from modules (`autoLoadEntities: true`)
- **Synchronization**: Disabled (`synchronize: false`) - always use migrations

### Connection Details

- **Development**: `localhost:5432` via docker-compose.yml
- **Test**: `localhost:5434` via docker-compose.test.yml
- **Connection String**: Set via `DATABASE_URL` environment variable

### Database Operations

#### Running Migrations

```bash
# From monorepo root
./packages/cli/bin/evently db migrate

# Or using pnpm
pnpm --filter api migration:run
```

#### Generating Migrations

```bash
pnpm --filter api migration:generate -n DescriptiveMigrationName
```

Migrations are created in `apps/api/src/database/migrations/`.

#### Resetting Database

```bash
# Warning: This destroys all data
./packages/cli/bin/evently db reset
```

This command:
1. Stops and removes database container with volumes
2. Starts fresh database
3. Runs all migrations

## Project Structure

```
apps/api/
├── src/
│   ├── app.module.ts           # Root application module
│   ├── main.ts                 # Application entry point
│   ├── config/
│   │   └── env.ts              # Environment validation (Zod)
│   ├── common/                 # Shared utilities
│   │   ├── interceptors/       # Response transformers
│   │   └── middleware/         # Request processing
│   ├── database/
│   │   ├── database.module.ts  # TypeORM configuration
│   │   └── migrations/         # Database migrations
│   └── modules/                # Feature modules
│       ├── auth/               # Authentication
│       ├── events/             # Event management
│       └── users/              # User management
├── test/                       # Integration tests
└── package.json
```

## Module Architecture

Each feature module follows a consistent structure:

```
modules/<feature>/
├── entities/
│   └── <feature>.entity.ts     # TypeORM entity
├── dto/
│   ├── create-<feature>.dto.ts # Request validation
│   └── update-<feature>.dto.ts
├── <feature>.controller.ts      # HTTP endpoints
├── <feature>.service.ts         # Business logic
└── <feature>.module.ts          # Module definition
```

## Testing

### Unit Tests

```bash
# Run all unit tests
pnpm test

# Run in watch mode
pnpm test:watch

# Generate coverage report (50% threshold enforced)
pnpm test:cov
```

### Integration Tests

Integration tests use an ephemeral database on port 5434:

```bash
# Start test database
docker compose -f docker-compose.test.yml up -d

# Run integration tests
pnpm test:integration

# Cleanup
docker compose -f docker-compose.test.yml down
```

Test configuration is in `test/jest-integration.json`.

## API Usage Examples

### Health Check

```bash
curl http://localhost:3000/health
```

Response:
```json
{
  "status": "ok",
  "info": {
    "database": {"status": "up"}
  }
}
```

### Create Event

```bash
curl -X POST http://localhost:3000/events \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Tech Conference 2026",
    "date": "2026-06-15T09:00:00Z",
    "description": "Annual technology conference",
    "place": "San Francisco, CA"
  }'
```

### List Events

```bash
curl http://localhost:3000/events
```

### Get Single Event

```bash
curl http://localhost:3000/events/1
```

### Update Event

```bash
curl -X PUT http://localhost:3000/events/1 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Event Name",
    "date": "2026-06-16T09:00:00Z",
    "description": "Updated description",
    "place": "San Francisco, CA"
  }'
```

### Delete Event

```bash
curl -X DELETE http://localhost:3000/events/1
```

## Security Features

### HTTP Security Headers

Helmet middleware configures:
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Strict-Transport-Security
- Content-Security-Policy

### Rate Limiting

- 100 requests per minute per IP address
- Configurable via environment variables
- Returns 429 Too Many Requests when exceeded

### CORS

Cross-Origin Resource Sharing is configured to allow requests from:
- Development: All origins (`*`)
- Production: Specific domains via `CORS_ORIGIN` environment variable

### Input Validation

All DTOs use class-validator decorators:
- Type validation
- Format validation
- Required field enforcement
- Whitelist mode (strips unknown properties)

## Logging

Structured JSON logs using Pino:

```json
{
  "level": "info",
  "time": 1673456789000,
  "msg": "Request completed",
  "correlationId": "uuid-v4",
  "method": "GET",
  "path": "/events",
  "statusCode": 200,
  "duration": 45
}
```

Each request receives a unique correlation ID for tracing.

## Development Commands

```bash
# Start in watch mode
pnpm dev

# Build for production
pnpm build

# Format code
pnpm format

# Lint code
pnpm lint

# Type check
pnpm check-types
```

## Troubleshooting

### Database Connection Errors

```bash
# Verify database is running
docker compose ps db

# Check connection string
echo $DATABASE_URL

# Restart database
docker compose down
docker compose up -d db
```

### Migration Failures

```bash
# Check migration status
pnpm --filter api migration:show

# Revert last migration
pnpm --filter api migration:revert

# Check database schema
docker compose exec db psql -U postgres -d evently -c "\dt"
```

### Port Already in Use

```bash
# Find process using port 3000
lsof -ti:3000

# Kill process
lsof -ti:3000 | xargs kill -9

# Or change PORT in .env
```

## Related Documentation

- [Main README](../../README.md) - Complete project documentation
- [Web Application](../web/README.md) - Frontend application
- [CLAUDE.md](../../CLAUDE.md) - AI assistant development guide
- [Runbook](../../docs/RUNBOOK.md) - Operations guide
